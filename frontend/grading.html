<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Grading - ReadySetClass‚Ñ¢</title>
    <link rel="icon" href="/assets/ReadySetClass_alpha_badge.png" type="image/png">

    <meta name="description" content="AI-powered grading that saves 90% of your time">
    <meta name="copyright" content="¬© 2026 ContentCreators.life. All rights reserved.">
    <meta name="trademark" content="ReadySetClass is a trademark of ContentCreators.life, first used February 2026">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- i18n Support -->
    <script src="/assets/i18n.js"></script>

    <!-- Tooltips System -->
    <script src="/assets/tooltips.js"></script>

    <style>
        :root {
            --primary-navy: #1E3A5F;
            --accent-gold: #C9A961;
            --background-cream: #F5F2E8;
            --text-dark: #2C3E50;
            --text-light: #666666;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --font-display: 'Sora', sans-serif;
            --font-body: 'DM Sans', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--background-cream);
            color: var(--text-dark);
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 2px solid rgba(0,0,0,0.05);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-navy);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Assignment Cards */
        .assignments-grid {
            display: grid;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .assignment-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .assignment-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .assignment-header h3 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-navy);
            margin-bottom: 0.5rem;
        }

        .course-tag {
            display: inline-block;
            background: var(--background-cream);
            color: var(--text-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .assignment-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--background-cream);
            border-radius: 8px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat label {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .stat value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .stat value.warning {
            color: var(--error);
        }

        .stat value.success {
            color: var(--success);
        }

        .assignment-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-navy);
            color: white;
        }

        .btn-primary:hover {
            background: #152a45;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
        }

        .btn-ai {
            background: linear-gradient(135deg, var(--primary-navy), var(--accent-gold));
            color: white;
            font-weight: 700;
        }

        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 95, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-navy);
            border: 2px solid var(--primary-navy);
        }

        .btn-secondary:hover {
            background: var(--primary-navy);
            color: white;
        }

        .btn-text {
            background: transparent;
            color: var(--text-light);
            padding: 0.5rem 1rem;
        }

        .btn-text:hover {
            color: var(--primary-navy);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .modal-header h2 {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 0.5rem;
        }

        .modal-header .subtitle {
            color: var(--text-light);
            font-size: 1rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .setup-section {
            margin-bottom: 2rem;
        }

        .setup-section h3 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-navy);
            margin-bottom: 1rem;
        }

        .rubric-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .rubric-table th {
            background: var(--background-cream);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
        }

        .rubric-table td {
            padding: 0.75rem;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .preference-item {
            margin: 1rem 0;
        }

        .preference-item label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            cursor: pointer;
        }

        .preference-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .help-text {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            margin-left: 1.75rem;
        }

        .summary-box {
            background: var(--background-cream);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .summary-box p {
            margin: 0.5rem 0;
        }

        .cost-info {
            background: #e0f2fe;
            border-left: 4px solid var(--info);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .modal-actions {
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Progress Screen */
        .progress-screen {
            text-align: center;
            padding: 3rem 2rem;
        }

        .progress-circle {
            width: 150px;
            height: 150px;
            margin: 2rem auto;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-navy);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            overflow: hidden;
            margin: 2rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-navy), var(--accent-gold));
            transition: width 0.3s ease;
        }

        .completed-feed {
            margin-top: 2rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .feed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            margin: 0.5rem 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-left-color: var(--primary-navy);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Language Selector */
        #language-selector-container {
            position: relative;
        }

        /* Review Interface */
        .review-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .review-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .review-title h2 {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 0.5rem;
        }

        .review-title p {
            color: var(--text-light);
            font-size: 1rem;
        }

        .review-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-box {
            background: var(--background-cream);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .stat-box value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-navy);
        }

        .stat-box value.success {
            color: var(--success);
        }

        .stat-box value.warning {
            color: var(--warning);
        }

        /* Review Controls */
        .review-controls {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary-navy);
            background: white;
            color: var(--primary-navy);
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: var(--background-cream);
        }

        .filter-btn.active {
            background: var(--primary-navy);
            color: white;
        }

        .sort-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sort-buttons label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .sort-buttons select {
            padding: 0.5rem;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: var(--font-body);
            cursor: pointer;
        }

        .bulk-actions {
            margin-left: auto;
        }

        /* Grade Cards */
        .grade-cards-container {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .grade-card {
            background: white;
            border-radius: 12px;
            border: 2px solid rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .grade-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .grade-card.reviewed {
            border-color: var(--success);
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05) 0%, white 10%);
        }

        .grade-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--background-cream);
            border-bottom: 2px solid rgba(0,0,0,0.05);
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .student-info h3 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-navy);
        }

        .confidence-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .confidence-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .confidence-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-badge.danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .flag-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            background: #fee2e2;
            color: #991b1b;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .reviewed-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            background: #d1fae5;
            color: #065f46;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .grade-score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .score-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .score-input {
            width: 80px;
            padding: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            border: 2px solid var(--primary-navy);
            border-radius: 8px;
            font-family: var(--font-body);
            color: var(--primary-navy);
        }

        .score-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.2);
        }

        .score-max {
            font-size: 1rem;
            color: var(--text-light);
        }

        /* Grade Card Body */
        .grade-card-body {
            padding: 1.5rem;
        }

        .rubric-breakdown {
            margin-bottom: 1.5rem;
        }

        .rubric-breakdown h4 {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 1rem;
        }

        .rubric-row {
            display: grid;
            grid-template-columns: 2fr 1fr 3fr;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--background-cream);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .criterion-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .criterion-score {
            font-weight: 700;
            color: var(--primary-navy);
        }

        .criterion-feedback {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        /* Feedback Section */
        .feedback-section {
            margin-bottom: 1.5rem;
        }

        .feedback-section h4 {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 1rem;
        }

        .feedback-textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 0.9375rem;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .feedback-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Grade Actions */
        .grade-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        /* Submission Text */
        .submission-text-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(0,0,0,0.05);
        }

        .submission-text-container h4 {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-navy);
            margin-bottom: 1rem;
        }

        .submission-text {
            padding: 1rem;
            background: var(--background-cream);
            border-radius: 8px;
            font-size: 0.9375rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Review Footer */
        .review-footer {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .review-footer .inline-hint {
            display: block;
            margin-bottom: 1.5rem;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .assignment-stats {
                grid-template-columns: 1fr;
            }

            .assignment-actions {
                flex-direction: column;
            }

            .modal-content {
                max-width: 95%;
                max-height: 95vh;
            }

            .review-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .bulk-actions {
                margin-left: 0;
            }

            .grade-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .rubric-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .grade-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div style="display: flex; align-items: center; gap: 8px;">
            <h1>‚ú® AI Grading</h1>
            <span class="tooltip-trigger" data-tooltip="AI grades student submissions in 3-5 minutes, saving you ~90% of grading time. You review and approve all grades before posting.">?</span>
        </div>
        <div class="header-actions">
            <div id="language-selector-container"></div>
            <button class="btn btn-text" onclick="window.location.href='dashboard-v2.html'">‚Üê Back to Dashboard</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div id="app-container">
            <!-- Loading state shows first -->
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- AI Grading Setup Modal -->
    <div id="setup-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Up AI Grading</h2>
                <p class="subtitle">Configure how AI should grade this assignment</p>
            </div>

            <div class="modal-body">
                <!-- Help Section -->
                <div class="help-section">
                    <div class="help-section-header">
                        <span class="help-arrow">‚ñ∂</span>
                        <span>How AI Grading Works</span>
                    </div>
                    <div class="help-section-content">
                        <ul>
                            <li><strong>Step 1:</strong> AI reads each submission and grades against your rubric</li>
                            <li><strong>Step 2:</strong> AI generates personalized feedback for each criterion</li>
                            <li><strong>Step 3:</strong> You review AI suggestions and approve/edit as needed</li>
                            <li><strong>Step 4:</strong> Post approved grades to Canvas</li>
                        </ul>
                        <p style="margin-top: 12px;"><strong>Time savings:</strong> 25 submissions = 10 hours manual ‚Üí 1 hour with AI (90% faster!)</p>
                    </div>
                </div>

                <!-- Step 1: Rubric -->
                <div class="setup-section">
                    <h3>
                        1. Grading Rubric
                        <span class="tooltip-trigger" data-tooltip="A rubric defines grading criteria (e.g., Thesis: 20pts, Evidence: 30pts). AI uses this to grade consistently across all submissions.">?</span>
                    </h3>
                    <div id="rubric-preview">
                        <!-- Rubric will be inserted here -->
                    </div>
                </div>

                <!-- Step 2: Preferences -->
                <div class="setup-section">
                    <h3>
                        2. Grading Preferences
                        <span class="tooltip-trigger" data-tooltip="Customize how AI grades submissions. You can change these anytime.">?</span>
                    </h3>

                    <div class="preference-item">
                        <label>
                            <input type="checkbox" id="pref-feedback" checked />
                            Generate personalized feedback for each student
                        </label>
                        <p class="help-text">AI writes 2-3 sentences of constructive feedback per criterion</p>
                    </div>

                    <div class="preference-item">
                        <label>
                            <input type="checkbox" id="pref-flag" checked />
                            Flag submissions that need manual review
                        </label>
                        <p class="help-text">AI marks low-confidence grades for your attention</p>
                    </div>

                    <div class="preference-item">
                        <label>
                            <input type="checkbox" id="pref-ai-content" />
                            Check for AI-generated content
                        </label>
                        <p class="help-text">Flag submissions likely written by ChatGPT/AI</p>
                    </div>

                    <div class="preference-item">
                        <label>
                            Grading Strictness:
                            <span class="tooltip-trigger" data-tooltip="Lenient = generous grading, Balanced = fair and objective, Strict = high standards and critical. Affects how AI interprets rubric criteria.">?</span>
                        </label>
                        <select id="pref-strictness" style="margin-left: 1rem; padding: 0.5rem; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="lenient">Lenient (grade generously)</option>
                            <option value="balanced" selected>Balanced (grade fairly)</option>
                            <option value="strict">Strict (high standards)</option>
                        </select>
                    </div>

                    <div class="quick-tip">
                        <strong>Pro tip:</strong> Start with "Balanced" and adjust if grades seem too high or low
                    </div>
                </div>

                <!-- Step 3: Summary -->
                <div class="setup-section">
                    <h3>3. Ready to Grade</h3>

                    <div class="summary-box">
                        <p><strong>AI will grade:</strong> <span id="summary-count">0</span> submissions</p>
                        <p><strong>Using rubric:</strong> <span id="summary-rubric">Loading...</span></p>
                        <p><strong>Estimated time:</strong> 3-5 minutes</p>
                        <p><strong>You'll review:</strong> Each grade before posting</p>
                    </div>

                    <div class="cost-info">
                        <p>üí° <strong>This feature is included in your Pro plan</strong></p>
                        <p>Unlimited AI grading, no extra charge!</p>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSetupModal()">Cancel</button>
                <button class="btn btn-primary btn-large" onclick="startAIGrading()">
                    ‚ú® Start AI Grading
                </button>
            </div>
        </div>
    </div>

    <!-- Language Selector -->
    <script src="/assets/language-selector.js"></script>

    <script>
        // Global state
        let currentCourseId = null;
        let currentAssignmentId = null;
        let currentAssignment = null;
        let gradingSession = null;

        // API Base URL
        const API_BASE = 'https://facultyflow-production.up.railway.app';

        // Initialize app
        async function init() {
            // Get course/assignment from URL params or show all assignments
            const urlParams = new URLSearchParams(window.location.search);
            currentCourseId = urlParams.get('course_id');
            currentAssignmentId = urlParams.get('assignment_id');

            if (currentCourseId && currentAssignmentId) {
                // Load specific assignment
                await loadAssignment();
            } else {
                // Load all assignments ready to grade
                await loadAssignments();
            }
        }

        // Load assignments ready to grade
        async function loadAssignments() {
            try {
                // For now, show a placeholder until we fetch from backend
                document.getElementById('app-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3>Assignments Ready to Grade</h3>
                        <p>Connect to Canvas to see assignments with ungraded submissions</p>
                        <button class="btn btn-primary" onclick="window.location.href='dashboard-v2.html'">
                            Go to Dashboard
                        </button>
                    </div>
                `;

                // TODO: Fetch from API
                // const response = await fetch(`${API_BASE}/api/ai-grading/assignments/ready-to-grade`);
                // const data = await response.json();
                // renderAssignments(data.assignments);

            } catch (error) {
                console.error('Error loading assignments:', error);
                showError('Failed to load assignments');
            }
        }

        // Load specific assignment
        async function loadAssignment() {
            try {
                // Mock data for now
                currentAssignment = {
                    name: "Media Ethics Essay",
                    course_name: "MCM 490 - Content Creation",
                    submissions_count: 25,
                    due_date: "Feb 12, 2026",
                    graded_count: 0
                };

                renderAssignmentCard();

            } catch (error) {
                console.error('Error loading assignment:', error);
                showError('Failed to load assignment');
            }
        }

        // Render assignment card
        function renderAssignmentCard() {
            const manual_time = Math.ceil(currentAssignment.submissions_count * 25 / 60);
            const ai_time = 1;

            document.getElementById('app-container').innerHTML = `
                <div class="assignments-grid">
                    <div class="assignment-card">
                        <div class="assignment-header">
                            <div>
                                <h3>${currentAssignment.name}</h3>
                                <span class="course-tag">${currentAssignment.course_name}</span>
                            </div>
                        </div>

                        <div class="assignment-stats">
                            <div class="stat">
                                <label>Submissions:</label>
                                <value>${currentAssignment.submissions_count} students</value>
                            </div>

                            <div class="stat">
                                <label>Due Date:</label>
                                <value>${currentAssignment.due_date}</value>
                            </div>

                            <div class="stat">
                                <label>Graded:</label>
                                <value>${currentAssignment.graded_count} / ${currentAssignment.submissions_count} (${Math.round(currentAssignment.graded_count / currentAssignment.submissions_count * 100)}%)</value>
                            </div>

                            <div class="stat">
                                <label>Estimated Time:</label>
                                <value class="warning">~${manual_time} hours manual</value>
                                <value class="success">~${ai_time} hour with AI ‚ú®</value>
                            </div>
                        </div>

                        <div class="assignment-actions">
                            <button class="btn btn-primary btn-ai" onclick="openSetupModal()">
                                ‚ú® Grade with AI (Recommended)
                            </button>
                            <span class="inline-hint">AI grades in 3-5 min, you review in ~1 hour. Saves 90% of your time!</span>
                            <button class="btn btn-secondary" onclick="alert('Opens Canvas grading page')">
                                Grade Manually in Canvas
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Open setup modal
        function openSetupModal() {
            // Mock rubric for demo
            const rubric = {
                criteria: [
                    {name: "Thesis Statement", points: 20, description: "Clear, arguable thesis"},
                    {name: "Evidence & Support", points: 30, description: "Strong evidence from sources"},
                    {name: "Analysis", points: 30, description: "Critical thinking and depth"},
                    {name: "Writing Quality", points: 20, description: "Grammar and clarity"}
                ]
            };

            // Render rubric
            const rubricHTML = `
                <table class="rubric-table">
                    <thead>
                        <tr>
                            <th>Criterion</th>
                            <th>Points</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rubric.criteria.map(c => `
                            <tr>
                                <td>${c.name}</td>
                                <td>${c.points} points</td>
                                <td>${c.description}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('rubric-preview').innerHTML = rubricHTML;
            document.getElementById('summary-count').textContent = currentAssignment.submissions_count;
            document.getElementById('summary-rubric').textContent = `${rubric.criteria.length} criteria, ${rubric.criteria.reduce((sum, c) => sum + c.points, 0)} points total`;

            document.getElementById('setup-modal').classList.add('active');
        }

        // Close setup modal
        function closeSetupModal() {
            document.getElementById('setup-modal').classList.remove('active');
        }

        // Start AI grading
        async function startAIGrading() {
            // Get preferences
            const preferences = {
                generate_feedback: document.getElementById('pref-feedback').checked,
                flag_low_confidence: document.getElementById('pref-flag').checked,
                check_ai_content: document.getElementById('pref-ai-content').checked,
                strictness: document.getElementById('pref-strictness').value
            };

            // Mock rubric
            const rubric = {
                criteria: [
                    {name: "Thesis Statement", points: 20, description: "Clear, arguable thesis"},
                    {name: "Evidence & Support", points: 30, description: "Strong evidence from sources"},
                    {name: "Analysis", points: 30, description: "Critical thinking and depth"},
                    {name: "Writing Quality", points: 20, description: "Grammar and clarity"}
                ]
            };

            closeSetupModal();

            // Show progress screen
            showProgressScreen();

            try {
                // Start grading session
                const response = await fetch(`${API_BASE}/api/ai-grading/sessions/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        course_id: currentCourseId,
                        assignment_id: currentAssignmentId,
                        rubric: rubric,
                        preferences: preferences
                    })
                });

                const data = await response.json();
                gradingSession = data;

                // Poll for progress
                pollGradingProgress(data.session_id);

            } catch (error) {
                console.error('Error starting grading:', error);
                alert('Failed to start AI grading. Please try again.');
                loadAssignment();
            }
        }

        // Show progress screen
        function showProgressScreen() {
            document.getElementById('app-container').innerHTML = `
                <div class="progress-screen">
                    <h2>AI is Grading Submissions...</h2>

                    <div class="progress-circle">
                        <svg width="150" height="150">
                            <circle cx="75" cy="75" r="70" fill="none" stroke="#f0f0f0" stroke-width="10"/>
                            <circle id="progress-ring" cx="75" cy="75" r="70" fill="none" stroke="url(#gradient)" stroke-width="10"
                                    stroke-dasharray="440" stroke-dashoffset="440" transform="rotate(-90 75 75)"/>
                            <defs>
                                <linearGradient id="gradient">
                                    <stop offset="0%" stop-color="#1E3A5F"/>
                                    <stop offset="100%" stop-color="#C9A961"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="progress-text">
                            <span class="current">0</span>
                            <span class="divider">/</span>
                            <span class="total">${currentAssignment.submissions_count}</span>
                        </div>
                    </div>

                    <p class="progress-status" id="progress-status">Starting...</p>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>

                    <p class="time-estimate" id="time-estimate">Estimating time...</p>

                    <div class="completed-feed" id="completed-feed">
                        <h3>Recently Graded:</h3>
                    </div>
                </div>
            `;
        }

        // Poll grading progress
        async function pollGradingProgress(sessionId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/ai-grading/sessions/${sessionId}/status`);
                    const data = await response.json();

                    // Update progress
                    const percent = data.progress_percent;
                    document.getElementById('progress-fill').style.width = `${percent}%`;
                    document.querySelector('.progress-text .current').textContent = data.graded_count;

                    // Update ring
                    const offset = 440 - (440 * percent / 100);
                    document.getElementById('progress-ring').style.strokeDashoffset = offset;

                    // Check if complete
                    if (data.status === 'completed') {
                        clearInterval(interval);
                        setTimeout(() => loadGradesForReview(sessionId), 1000);
                    }

                } catch (error) {
                    console.error('Error polling progress:', error);
                    clearInterval(interval);
                }
            }, 2000);
        }

        // Load grades for review
        async function loadGradesForReview(sessionId) {
            try {
                const response = await fetch(`${API_BASE}/api/ai-grading/sessions/${sessionId}/grades`);
                const data = await response.json();

                // Render review interface
                renderReviewInterface(data);

            } catch (error) {
                console.error('Error loading grades:', error);
                alert('Failed to load grades. Please refresh.');
            }
        }

        // Render review interface
        let currentSession = null;
        let currentGrades = [];
        let filterMode = 'all';
        let sortMode = 'confidence';

        function renderReviewInterface(data) {
            currentSession = data.session;
            currentGrades = data.grades;

            // Sort grades by confidence (high first)
            sortGrades();

            const reviewedCount = currentGrades.filter(g => g.reviewed).length;
            const highConfidenceCount = currentGrades.filter(g => g.ai_confidence === 'high').length;
            const flaggedCount = currentGrades.filter(g => g.ai_flags && g.ai_flags.length > 0).length;
            const avgScore = currentSession.average_score || 0;

            document.getElementById('app-container').innerHTML = `
                <div class="review-container">
                    <!-- Review Header -->
                    <div class="review-header">
                        <div class="review-title">
                            <h2>‚úÖ Review AI Grades</h2>
                            <p>${currentSession.assignment_title}</p>
                        </div>

                        <div class="review-stats">
                            <div class="stat-box">
                                <label>Reviewed</label>
                                <value>${reviewedCount} / ${currentSession.total_submissions}</value>
                            </div>
                            <div class="stat-box">
                                <label>Avg Score</label>
                                <value>${avgScore.toFixed(1)}%</value>
                            </div>
                            <div class="stat-box">
                                <label>High Confidence</label>
                                <value class="success">${highConfidenceCount}</value>
                            </div>
                            <div class="stat-box">
                                <label>Flagged</label>
                                <value class="warning">${flaggedCount}</value>
                            </div>
                        </div>
                    </div>

                    <!-- Filters and Actions -->
                    <div class="review-controls">
                        <div class="filter-buttons">
                            <button class="filter-btn ${filterMode === 'all' ? 'active' : ''}" onclick="setFilter('all')">
                                All (${currentGrades.length})
                            </button>
                            <button class="filter-btn ${filterMode === 'flagged' ? 'active' : ''}" onclick="setFilter('flagged')">
                                Flagged (${flaggedCount})
                            </button>
                            <button class="filter-btn ${filterMode === 'high' ? 'active' : ''}" onclick="setFilter('high')">
                                High Confidence (${highConfidenceCount})
                            </button>
                            <button class="filter-btn ${filterMode === 'needs_review' ? 'active' : ''}" onclick="setFilter('needs_review')">
                                Needs Review (${currentGrades.filter(g => !g.reviewed).length})
                            </button>
                        </div>

                        <div class="sort-buttons">
                            <label>Sort:</label>
                            <select onchange="sortMode = this.value; sortGrades(); renderGradeCards();">
                                <option value="confidence" ${sortMode === 'confidence' ? 'selected' : ''}>Confidence</option>
                                <option value="score" ${sortMode === 'score' ? 'selected' : ''}>Score</option>
                                <option value="name" ${sortMode === 'name' ? 'selected' : ''}>Student Name</option>
                            </select>
                        </div>

                        <div class="bulk-actions">
                            <button class="btn btn-secondary" onclick="approveAllHighConfidence()">
                                Approve All High Confidence (${highConfidenceCount})
                            </button>
                        </div>
                    </div>

                    <!-- Grade Cards Container -->
                    <div class="grade-cards-container" id="grade-cards">
                        ${renderGradeCards()}
                    </div>

                    <!-- Post to Canvas Button -->
                    <div class="review-footer">
                        <p class="inline-hint">Review and approve grades above, then post them to Canvas for students to see.</p>
                        <button class="btn btn-primary btn-large" onclick="confirmPostToCanvas()" ${reviewedCount === 0 ? 'disabled' : ''}>
                            üì§ Post ${reviewedCount} Reviewed Grade${reviewedCount !== 1 ? 's' : ''} to Canvas
                        </button>
                    </div>
                </div>
            `;
        }

        // Sort grades
        function sortGrades() {
            if (sortMode === 'confidence') {
                const order = {high: 0, medium: 1, low: 2};
                currentGrades.sort((a, b) => order[a.ai_confidence] - order[b.ai_confidence]);
            } else if (sortMode === 'score') {
                currentGrades.sort((a, b) => (b.ai_total_score || 0) - (a.ai_total_score || 0));
            } else if (sortMode === 'name') {
                currentGrades.sort((a, b) => (a.student_name || '').localeCompare(b.student_name || ''));
            }
        }

        // Set filter
        function setFilter(mode) {
            filterMode = mode;
            renderReviewInterface({session: currentSession, grades: currentGrades});
        }

        // Filter grades based on mode
        function getFilteredGrades() {
            if (filterMode === 'all') return currentGrades;
            if (filterMode === 'flagged') return currentGrades.filter(g => g.ai_flags && g.ai_flags.length > 0);
            if (filterMode === 'high') return currentGrades.filter(g => g.ai_confidence === 'high');
            if (filterMode === 'needs_review') return currentGrades.filter(g => !g.reviewed);
            return currentGrades;
        }

        // Render grade cards
        function renderGradeCards() {
            const filtered = getFilteredGrades();

            if (filtered.length === 0) {
                return '<div class="empty-state"><p>No submissions match this filter.</p></div>';
            }

            return filtered.map(grade => {
                const confidenceClass = grade.ai_confidence === 'high' ? 'success' : grade.ai_confidence === 'medium' ? 'warning' : 'danger';
                const confidenceIcon = grade.ai_confidence === 'high' ? '‚úÖ' : grade.ai_confidence === 'medium' ? '‚ö†Ô∏è' : 'üî¥';

                const flags = grade.ai_flags || [];
                const hasFlags = flags.length > 0;

                // Parse rubric scores
                const rubricScores = grade.ai_rubric_scores || {};
                const criterionFeedback = grade.ai_criterion_feedback || {};

                const displayScore = grade.final_score !== null ? grade.final_score : grade.ai_total_score;
                const displayFeedback = grade.final_feedback || grade.ai_feedback;

                return `
                    <div class="grade-card ${grade.reviewed ? 'reviewed' : ''}" id="grade-${grade.id}">
                        <div class="grade-card-header">
                            <div class="student-info">
                                <h3>${grade.student_name}</h3>
                                <span class="confidence-badge ${confidenceClass}">
                                    ${confidenceIcon} ${grade.ai_confidence.toUpperCase()} CONFIDENCE
                                </span>
                                ${hasFlags ? `<span class="flag-badge">üö© ${flags.join(', ')}</span>` : ''}
                                ${grade.reviewed ? '<span class="reviewed-badge">‚úì Reviewed</span>' : ''}
                            </div>
                            <div class="grade-score">
                                <span class="score-label">Score:</span>
                                <input type="number"
                                       class="score-input"
                                       id="score-${grade.id}"
                                       value="${displayScore || 0}"
                                       min="0"
                                       max="100"
                                       onchange="updateGradeScore(${grade.id}, this.value)">
                                <span class="score-max">/ 100</span>
                            </div>
                        </div>

                        <div class="grade-card-body">
                            <!-- Rubric Breakdown -->
                            <div class="rubric-breakdown">
                                <h4>Rubric Breakdown:</h4>
                                ${Object.keys(rubricScores).map(criterion => `
                                    <div class="rubric-row">
                                        <span class="criterion-name">${criterion}</span>
                                        <span class="criterion-score">${rubricScores[criterion]} pts</span>
                                        ${criterionFeedback[criterion] ? `<span class="criterion-feedback">${criterionFeedback[criterion]}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Overall Feedback -->
                            <div class="feedback-section">
                                <h4>Overall Feedback:</h4>
                                <textarea
                                    class="feedback-textarea"
                                    id="feedback-${grade.id}"
                                    rows="4"
                                    onchange="updateGradeFeedback(${grade.id}, this.value)"
                                >${displayFeedback || ''}</textarea>
                            </div>

                            <!-- Actions -->
                            <div class="grade-actions">
                                <button class="btn btn-success" onclick="approveGrade(${grade.id})">
                                    ${grade.reviewed ? '‚úì Approved' : 'Approve'}
                                </button>
                                <button class="btn btn-secondary" onclick="regenerateGrade(${grade.id})">
                                    üîÑ Regenerate
                                </button>
                                <button class="btn btn-ghost" onclick="toggleSubmissionText(${grade.id})">
                                    üìÑ View Submission
                                </button>
                            </div>

                            <!-- Submission Text (Hidden by default) -->
                            <div class="submission-text-container" id="submission-${grade.id}" style="display: none;">
                                <h4>Student Submission:</h4>
                                <div class="submission-text">${grade.submission_text || 'No submission text available.'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update grade score
        function updateGradeScore(gradeId, score) {
            const grade = currentGrades.find(g => g.id === gradeId);
            if (grade) {
                grade.final_score = parseFloat(score);
            }
        }

        // Update grade feedback
        function updateGradeFeedback(gradeId, feedback) {
            const grade = currentGrades.find(g => g.id === gradeId);
            if (grade) {
                grade.final_feedback = feedback;
            }
        }

        // Toggle submission text
        function toggleSubmissionText(gradeId) {
            const element = document.getElementById(`submission-${gradeId}`);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }

        // Approve grade
        async function approveGrade(gradeId) {
            const grade = currentGrades.find(g => g.id === gradeId);
            if (!grade) return;

            try {
                const response = await fetch(`${API_BASE}/api/ai-grading/grades/${gradeId}/review`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        final_score: grade.final_score !== null ? grade.final_score : grade.ai_total_score,
                        final_feedback: grade.final_feedback || grade.ai_feedback
                    })
                });

                if (response.ok) {
                    grade.reviewed = true;
                    renderReviewInterface({session: currentSession, grades: currentGrades});
                } else {
                    alert('Failed to approve grade. Please try again.');
                }
            } catch (error) {
                console.error('Error approving grade:', error);
                alert('Failed to approve grade. Please try again.');
            }
        }

        // Approve all high confidence grades
        async function approveAllHighConfidence() {
            const highConfidenceGrades = currentGrades.filter(g => g.ai_confidence === 'high' && !g.reviewed);

            if (highConfidenceGrades.length === 0) {
                alert('No high confidence grades to approve.');
                return;
            }

            if (!confirm(`Approve ${highConfidenceGrades.length} high confidence grades?`)) {
                return;
            }

            for (const grade of highConfidenceGrades) {
                await approveGrade(grade.id);
            }
        }

        // Regenerate grade
        async function regenerateGrade(gradeId) {
            if (!confirm('Regenerate AI grade for this submission? This will overwrite the current grade.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/ai-grading/grades/${gradeId}/regenerate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                if (response.ok) {
                    const data = await response.json();
                    const grade = currentGrades.find(g => g.id === gradeId);
                    if (grade) {
                        grade.ai_total_score = data.ai_total_score;
                        grade.ai_feedback = data.ai_feedback;
                        grade.final_score = null;
                        grade.final_feedback = null;
                        grade.reviewed = false;
                        renderReviewInterface({session: currentSession, grades: currentGrades});
                    }
                } else {
                    alert('Failed to regenerate grade. Please try again.');
                }
            } catch (error) {
                console.error('Error regenerating grade:', error);
                alert('Failed to regenerate grade. Please try again.');
            }
        }

        // Confirm post to Canvas
        function confirmPostToCanvas() {
            const reviewedGrades = currentGrades.filter(g => g.reviewed);
            const unreviewedCount = currentGrades.length - reviewedGrades.length;

            if (reviewedGrades.length === 0) {
                alert('Please review at least one grade before posting to Canvas.');
                return;
            }

            const scores = reviewedGrades.map(g => g.final_score || g.ai_total_score);
            const avgScore = scores.reduce((sum, s) => sum + s, 0) / scores.length;
            const minScore = Math.min(...scores);
            const maxScore = Math.max(...scores);

            const message = `Post ${reviewedGrades.length} grades to Canvas?\n\n` +
                          `Grade Distribution:\n` +
                          `- Average: ${avgScore.toFixed(1)}%\n` +
                          `- Range: ${minScore.toFixed(1)}% - ${maxScore.toFixed(1)}%\n\n` +
                          (unreviewedCount > 0 ? `Note: ${unreviewedCount} submission(s) not yet reviewed will NOT be posted.` : '');

            if (confirm(message)) {
                postToCanvas();
            }
        }

        // Post to Canvas
        async function postToCanvas() {
            try {
                const response = await fetch(`${API_BASE}/api/ai-grading/sessions/${currentSession.id}/post-to-canvas`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Success!\n\nPosted ${data.success_count} grades to Canvas.` +
                          (data.failed_count > 0 ? `\n\n‚ö†Ô∏è ${data.failed_count} grades failed to post.` : ''));
                    init(); // Return to assignment list
                } else {
                    alert('Failed to post grades to Canvas. Please try again.');
                }
            } catch (error) {
                console.error('Error posting to Canvas:', error);
                alert('Failed to post grades to Canvas. Please try again.');
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('app-container').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="init()">Try Again</button>
                </div>
            `;
        }

        // Initialize on page load
        init();
    </script>

    <!-- Copyright Footer -->
    <footer style="text-align: center; padding: 2rem; color: var(--text-light); font-size: 0.875rem;">
        <p>¬© 2026 ContentCreators.life. All rights reserved. | ReadySetClass‚Ñ¢ is a trademark of ContentCreators.life</p>
    </footer>

</body>
</html>
